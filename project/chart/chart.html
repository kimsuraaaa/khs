<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="image/favicon.ico" />
    <title>chart</title>
    <script type="text/javascript" src="http://d3js.org/d3.v5.js"></script>
    <link rel="stylesheet" href="chart.css" />
  </head>
  <style>
    #svg-area {
      position: relative;
    }

    #tooltip {
      position: absolute;
      opacity: 0;
      width: 40px;
      height: 20px;
      line-height: 20px;
      transition: all 0.3s;
      border-radius: 5px;
      text-align: center;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
    }
    section {
      text-align: center;
    }
    section h1 {
      font-weight: 300;
      font-size: 500%;
      text-transform: uppercase;
    }
    section > div {
      display: block;
      margin: auto;
    }
    section .chart-box {
      display: inline-block;
      position: relative;
    }
  </style>
  <body>
    <div id="root">
      <!-- header -->
      <header>
        <h1><a href="/khs/project/chart/chart.html">HSCHART</a></h1>
      </header>
      <!-- // header -->
      <!-- chart body -->
      <section>
        <h1>bar chart</h1>
        <div class="chart-box" id="svg-area">
          <div id="tooltip"></div>
        </div>
      </section>
      <section>
        <h1>circle chart</h1>
        <div class="chart-box"></div>
      </section>
      <!-- // chart body -->
      <!-- footer -->
      <footer>
        <p>
          개인 스터디 페이지 입니다. &nbsp;
          <span>Copyright &copy; KIMHYUNSU, All rights reserved.</span>
        </p>
      </footer>
      <!-- // footer-->
      <script>
        // bar chart
        let data = [
          { name: 'test1', value: 10, color: '#5487b1' },
          { name: 'B', value: 29, color: '#63a1af' },
          { name: '가나다라마바', value: 32, color: '#7ab8aa' },
          { name: 'D', value: 25, color: '#93caa8' },
          { name: '테스트', value: 23, color: '#add7a8' },
          { name: 'F', value: 15, color: '#c6e3a7' },
          { name: '테스트2', value: 40, color: '#7ab8aa' },
          { name: '테스트4', value: 12, color: '#63a1af' },
          { name: '테스트5', value: 22, color: '#93caa8' },
          { name: '테스트6', value: 32, color: '#add7a8' },
        ];
        let width = data.length * 60; // 차트 영역의 가로값.
        let height = 400; // 차트 영역의 세로값.
        let margin = { top: 40, left: 40, bottom: 40, right: 40 }; // margin 값을 객체로 지정해둔다.

        // x
        const x = d3
          .scaleBand()
          .domain(data.map((d) => d.name)) // x축과 매칭되는 이름을 찾는다. 시작되는 입력 영역
          .range([margin.left, width - margin.right]) // x축 그래프 출력범위 (40, 400 - 40)
          .padding(0.5); // 그래프 두께의 padding 값. 0 ~ 1 사이로 적용.

        const y = d3
          .scaleLinear()
          .domain([0, d3.max(data, (d) => d.value)]) // 입력영역
          .nice()
          .range([height - margin.bottom, margin.top]); // 출력범위로 매핑

        const xAxis = (g) =>
          g
            .attr('transform', `translate(0, ${height - margin.bottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0))
            .call((g) => g.select('.domain').remove())
            .call((g) => g.selectAll('line').remove());

        const yAxis = (g) =>
          g
            .attr('transform', `translate(${margin.left}, 0)`)
            .call(d3.axisLeft(y))
            .call((g) => g.select('.domain').remove())
            .call((g) => g.selectAll('line').attr('x2', width).style('stroke', '#f5f5f5'));

        // svg 변수에 어떤 #svg-area 선택자에, svg 타입으로 추가하고, 그래프의 크기 width, height만큼 지정한다.
        const svg = d3
          .select('#svg-area')
          .append('svg')
          .style('width', width)
          .style('height', height);

        svg.append('g').call(xAxis);
        svg.append('g').call(yAxis);
        svg
          .append('g')
          .selectAll('rect')
          .data(data)
          .enter()
          .append('rect')
          .attr('x', (d) => x(d.name)) // 데이터와 매칭되는 요소에서 시작됨.
          .attr('y', (d) => y(d.value)) // y축 시작점
          .attr('rx', 5) // 그래프 radius 값.
          .attr('width', x.bandwidth()) // 그래프 폭.
          .attr('data-x', (d) => d.name) // 마우스 오버 데이터 이름.
          .attr('data-y', (d) => d.value) // 마우스 오버 데이터 값.
          .attr('data-color', (d) => d.color) // 마우스 오버 데이터 박스 bg.
          .transition() // 모션을 줄거야, 이 분기점 기준으로 아래에 선언.
          .duration(1500) // 속도는 1.5s.
          .attr('height', (d) => y(0) - y(d.value)) // 높이값 지정.
          .attr('fill', (d) => d.color); // 차트 막대 bg.

        svg.node();

        const rectEl = document.getElementsByTagName('rect');
        const tooltop = document.getElementById('tooltip');

        for (const el of rectEl) {
          el.addEventListener('mouseover', (event) => {
            const target = event.target;
            const positionLeft =
              Number(target.getAttribute('x')) +
              Number(x.bandwidth() / 2) -
              tooltop.clientWidth / 2;
            const positionTop =
              height - margin.top - target.getAttribute('height') - tooltop.clientHeight - 5;
            const color = target.dataset.color;
            const value = target.dataset.y;

            tooltop.innerText = value;
            tooltop.style.background = color;
            tooltop.style.top = positionTop + 'px';
            tooltop.style.left = positionLeft + 'px';
            tooltop.style.opacity = 1;
          });
        }
      </script>
    </div>
  </body>
</html>
